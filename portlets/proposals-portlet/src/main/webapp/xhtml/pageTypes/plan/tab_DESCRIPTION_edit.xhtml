<f:view 
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:collab="http://climatecollaboratorium.org/facelets"
    xmlns:ice="http://www.icesoft.com/icefaces/component"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:h="http://java.sun.com/jsf/html"  
    xmlns:ace="http://www.icefaces.org/icefaces/components"
    xmlns:addthis="http://www.addthis.com/help/api-spec" >
    <ice:panelGroup rendered="#{planBean.leaveThisPlan}">
        <script type="text/javascript">
            var location = window.location.toString();
            location = location.substring(0, location.indexOf("/planId"));
                
            window.location = location;
        </script>
    </ice:panelGroup>

    <div class="headline addprop">
        Please complete your proposal based on the template below. 
        If you have input on the template, please send it in a&#160;<a href="/web/guest/feedback" target="_blank">feedback message</a>.  
        To save your proposal, you must agree to the&#160;<a href="/web/guest/resources/-/wiki/Main/2012+contest+rules" target="_blank">Contest rules</a> 
        and&#160;<a href="/web/guest/resources/-/wiki/Main/Terms+of+use" target="_blank">Terms of use</a>.
    </div> <!-- /headline -->

    <div class="fileUploadContainer">
	<form action="/fileUpload" method="post" enctype="multipart/form-data" target="_fileUploadFrame" class="fileUpload" id="fileUploadForm">
		<input type="file" name="file" id="fileUploadInput" />
	</form>
	
    </div>
    <ice:form styleClass="addpropform">
    <div class="prop-left" id="addpropform">
        <ice:panelGroup styleClass="addpropbox q1">
            <label>
                <strong>Title</strong> 
                <a class="helpTrigger" href="javascript:;"><img src="/climatecolab-theme/images/icon-addprop-question.png" width="15" height="15" /></a><br />
                80 characters
            </label>
            <div class="addprophelp">Give your proposal a title. It's the first thing most people will see, so you'll want to make it descriptive and engaging.</div>
            <div class="addpropInputContainer">
                <ice:inputText value="#{plan.plan.name}" onchange="jQuery(this).addClass('valueChanged');" required="true" id="proposalName">
                    <f:attribute name="plan" value="#{plan.plan}"/>
                    <f:validator validatorId="planNameValidator"/>
                    <f:attribute name="planName" value="#{plan.plan.name}" />
                </ice:inputText>
                <div class="clearfix"></div>
         		<ice:message style="color: red;" id="proposalNameError" for="proposalName"/>
                <div class="inputLimitContainer"><span class="limit_characterCount"></span>/&#160;<span class="limit_charactersMax">80</span> characters</div>
                <div style="display: none">
                    <textarea class="originalValue">#{plan.plan.originalName}</textarea>
                </div>
            </div>
        </ice:panelGroup>
        <ice:panelGroup styleClass="addpropbox blue q2">
            <label>
                <span><strong>Team name</strong><br />
                <em>optional</em></span> 
                <a class="helpTrigger" href="javascript:;"><img src="/climatecolab-theme/images/icon-addprop-question.png" width="15" height="15" /></a><br />
                20 characters
            </label>
            <div class="addprophelp">If you'd like to have your proposal appear under a team name, insert it here. Otherwise, the proposal will appear under the user name of its owner.</div>
            <div class="addpropInputContainer">
                <ice:inputText value="#{proposal.plan.team}" />
                <div class="inputLimitContainer"><span class="limit_characterCount"></span>/&#160;<span class="limit_charactersMax">20</span> characters</div>
                <div style="display: none">
                    <textarea class="originalValue">#{plan.plan.originalTeam}</textarea>
                </div>
            </div>
        </ice:panelGroup>
        
        <div class="notation">Note: If you enter a team name, it will replace the proposal owner's name in the Author field.</div>
        
        <ice:panelGroup styleClass="addpropbox blue">
            <label>
                <span><strong>Proposal image</strong><br />
                <em>optional</em></span>
            </label>
            
            <ice:panelGroup styleClass="upload proposalImageUpload">
                    <div class="uploadbox" id="proposalImage">
                        <f:subview rendered="#{not empty proposal.plan.image}">
                            <img src="#{proposal.plan.image}" width="50px" height="50px" id="" />
                        </f:subview>
                        <f:subview rendered="#{empty proposal.plan.image}">
                            <img src="#{proposal.plan.image}" width="50px" height="50px" id="" style="display: none;"/>
                        </f:subview>
                        <ice:inputText value="#{proposal.plan.newImageId}" style="display: none;" styleClass="newImageId" />
                    </div>
                            
                    <div id="uploadWidget">
                    </div>
                    <div class="clear"><!--  --></div>
                    
            </ice:panelGroup>
        </ice:panelGroup>

        <ice:panelGroup styleClass="addpropbox q3">
            <label>
                <strong>Pitch</strong> 
                <a href="javascript:;" class="helpTrigger"><img src="/climatecolab-theme/images/icon-addprop-question.png" width="15" height="15" /></a><br />
                140 characters
            </label>
            <div class="addprophelp">Insert a tweet-length (140 character) message that conveys the key idea behind your proposal.</div>
            <div class="addpropInputContainer">
                <ice:inputTextarea value="#{proposal.plan.pitch}" cols="50" rows="7" style="display: inline; resize: none;" styleClass="proposalPitchInput"/>
                <div class="inputLimitContainer">
                    <span class="limit_characterCount"></span>/&#160;<span class="limit_charactersMax">140</span> characters
                </div>
                <div style="display: none">
                    <textarea class="originalValue">#{plan.plan.originalAbstract}</textarea>
                </div>
            </div>
            
            <script>
                jQuery("textarea.proposalPitchInput").keydown(function(e) {
                    var TABKEY = 9;
                    if(e.keyCode == TABKEY) {
                        this.value += "    ";
                        if(e.preventDefault) {
                            e.preventDefault();
                        }
                        return false;
                    }
                });
            </script>
        </ice:panelGroup>
        
        <!--  if proposal has sections - render edit forms for sections -->
        <ice:panelGroup rendered="#{proposal.plan.hasSections}">
            <ice:panelSeries var="section" value="#{proposal.plan.sections}">
                <f:subview rendered="#{section.type == 'TEXT'}">
                	<ui:include src="./sections/edit_section_TEXT.xhtml" />
                </f:subview>
                <f:subview rendered="#{section.type == 'PROPOSAL_REFERENCE'}">
                	<ui:include src="./sections/edit_section_PROPOSAL_REFERENCE.xhtml" />
                </f:subview>
            </ice:panelSeries>
        </ice:panelGroup>
        
        <ice:panelGroup rendered="#{not proposal.plan.hasSections}">
            <ice:panelGroup styleClass="addpropbox">
                <label>
                    <strong>Description</strong> 
                    <a href="javascript:;" class="helpTrigger"><img src="/climatecolab-theme/images/icon-addprop-question.png" width="15" height="15" /></a><br />
                </label>
                <div class="addprophelp">Enter proposal assumptions, actions, describe your ideas.</div>
                <div class="addpropInputContainer">
                    <ice:inputTextarea value="#{proposal.plan.description}"  cols="54" rows="7" styleClass="rte" />
                    <div style="display: none">
                        <textarea class="originalValue">#{plan.plan.originalDescription}</textarea>
                    </div>
                </div>
            </ice:panelGroup>
        </ice:panelGroup>
        
        <ui:include src="sections/common_section_edit_scripts.xhtml" />
   
    </div>
    
    <ui:include src="./widget_PROPOSAL_SUMMARY.xhtml" />
    
    <ui:include src="sections/common_sections_popups_buttons.xhtml" />
   
   	<iframe name="_fileUploadFrame" id="fileUploadFrame" class="hidden" 	style="display: none;">
			<!-- comment -->
	</iframe>
	<script type="text/javascript">
			jQuery("#fileUploadInput").change(function() {
				jQuery(".proposalImageUpload .portlet-msg-error").remove();
				jQuery("#fileUploadForm").submit();
				jQuery("#proposalImage").block();

			});
			jQuery("#fileUploadFrame").load(
					function() {
						var response = eval("(" + jQuery(this).contents().text() + ")");
						jQuery("#proposalImage").unblock();
						
						if (response.success) {
							jQuery("#proposalImage img").attr("src",
									"/image/contest?img_id=" + response.imageId).show();
							jQuery(".newImageId", "#proposalImage").val(response.imageId);
						}
						else {
							jQuery(".proposalImageUpload").append("&lt;div class='portlet-msg-error'&gt;" + response.message + "&lt;/div&gt;");
						}

			});
			

			var containerOffset = jQuery("#uploadWidget").offset();

			jQuery("#fileUploadInput").offset(containerOffset);
	    	
		</script>
		
        </ice:form>
 </f:view>